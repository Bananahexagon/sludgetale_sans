const A=(s,t)=>{s()||(t(),requestAnimationFrame(()=>A(s,t)))},M=(s,t,r=0)=>{r<s&&(t(r),requestAnimationFrame(()=>M(s,t,r+1)))},P=s=>{s(),requestAnimationFrame(()=>P(s))},F=[{type:"image",name:"soul",src:"./assets/images/soul.png"},{type:"image",name:"soul_blue",src:"./assets/images/soul_blue.png"},{type:"image",name:"commands",src:"./assets/images/commands.png"},{type:"image",name:"back",src:"./assets/images/back.png"},{type:"image",name:"sans",src:"./assets/images/sans.png"},{type:"image",name:"hp_kr_purple",src:"./assets/images/hp_kr_purple.png"},{type:"image",name:"determination_white",src:"./assets/images/font/determination_white.png"},{type:"image",name:"determination_red",src:"./assets/images/font/determination_red.png"},{type:"image",name:"determination_orange",src:"./assets/images/font/determination_orange.png"},{type:"image",name:"determination_blue",src:"./assets/images/font/determination_blue.png"},{type:"image",name:"determination_yellow",src:"./assets/images/font/determination_yellow.png"},{type:"image",name:"status_white",src:"./assets/images/font/status_white.png"},{type:"image",name:"status_red",src:"./assets/images/font/status_red.png"},{type:"image",name:"status_orange",src:"./assets/images/font/status_orange.png"},{type:"image",name:"status_blue",src:"./assets/images/font/status_blue.png"},{type:"image",name:"status_yellow",src:"./assets/images/font/status_yellow.png"},{type:"image",name:"status_purple",src:"./assets/images/font/status_purple.png"},{type:"image",name:"hp_kr_white",src:"./assets/images/hp_kr_white.png"},{type:"image",name:"hp_kr_red",src:"./assets/images/hp_kr_red.png"},{type:"image",name:"hp_kr_purple",src:"./assets/images/hp_kr_purple.png"},{type:"image",name:"bone_head_white",src:"./assets/images/bone_head_white.png"},{type:"image",name:"bananahexagon",src:"./assets/images/normal_icon.png"}],L=async()=>{const s={},t={},r={},u=F,e=[];return console.log(u),u.forEach(l=>e.push(new Promise(h=>{switch(l.type){case"image":{const i=new Image;i.src=l.src,i.onload=()=>{s[l.name]=i,h()}}break;case"audio":{const i=new Audio;i.src=l.src,i.onload=()=>{t[l.name]=i,h()}}break;case"font":(async()=>{const c=await(await(await fetch(l.src)).text()).match(/url\(.+?\)/g);if(!c)throw new Error("フォントが見つかりませんでした");const y=[];c.forEach(o=>{y.push((async()=>{const a=new FontFace(l.name,o);await a.load(),r[l.name]=a,await document.fonts.add(a)})())}),Promise.all(y)})().then(h)}}))),await Promise.all(e),console.log(r),{Images:s,Audios:t,Fonts:r}},k=s=>Math.sin(s/360*Math.PI*2),w=s=>Math.cos(s/360*Math.PI*2),I=(s,t,r,u,e,l)=>{const h=(y,o,a,n=0,m=100,_=1,p="center",v=!1)=>{if(v){const g=r[y],q=g.width,f=g.height;switch(t.globalAlpha=_,p){case"center":t.save(),t.translate(o*e.display_quality,-a*e.display_quality+s.height),t.rotate(n*Math.PI/180),t.drawImage(g,-q*m/200*e.display_quality,-f*m/200*e.display_quality,q*m/100*e.display_quality,f*m/100*e.display_quality),t.restore();break;case"start":t.save(),t.translate(o*e.display_quality,-a*e.display_quality+s.height),t.rotate(n*Math.PI/180),t.drawImage(g,0,0,q*m/100*e.display_quality,f*m/100*e.display_quality),t.restore()}}else{const g=(w(l.d)*o-k(l.d)*a+l.x)*l.size/100,q=(k(l.d)*o+w(l.d)*a+l.y)*l.size/100,f=n+l.d;h(y,g,q,f,m*l.size/100,_,p,!0)}};return{stamp:h,drawRect:(y,o,a,n,m,_=0,p="center")=>{switch(t.save(),p){case"center++":t.translate(y*e.display_quality,-o*e.display_quality+s.height),t.rotate(_*Math.PI/180),t.beginPath(),t.rect(-a/2*e.display_quality,-n/2*e.display_quality,a*e.display_quality,n*e.display_quality);break;case"center":t.translate((y-a/2)*e.display_quality,-(o-n/2)*e.display_quality+s.height),t.rotate(_*Math.PI/180),t.beginPath(),t.rect(0,0,a*e.display_quality,-n*e.display_quality);break;case"start":default:t.translate(y*e.display_quality,-o*e.display_quality+s.height),t.rotate(_*Math.PI/180),t.beginPath(),t.rect(0,0,a*e.display_quality,-n*e.display_quality);break}t.fillStyle=m,t.fill(),t.restore()},drawLine:(y,o,a,n,m,_,p=0)=>{switch(t.beginPath(),p){case 0:t.moveTo((y-n*Math.sin(a)/2)*e.display_quality,-(o+n*Math.cos(a)/2)*e.display_quality+s.height),t.lineTo((y+n*Math.sin(a)/2)*e.display_quality,-(o-n*Math.cos(a)/2)*e.display_quality+s.height);break;case 1:t.moveTo(y*e.display_quality,-o*e.display_quality+s.height),t.lineTo((y+n*Math.sin(a))*e.display_quality,-(o-n*Math.cos(a))*e.display_quality+s.height);break}t.strokeStyle=_,t.lineWidth=m*e.display_quality,t.stroke()},drawText:(y,o,a,n,m,_="serif",p="left")=>{const[v,g]=[o*e.display_quality,-a*e.display_quality+s.height];t.font=`${n*e.display_quality}px ${_}`,t.textAlign=p,t.fillStyle=m,t.fillText(y,v,g)}}},E=s=>{class t{constructor(u,e,l=0,h=100,i="",d=!1){this.x=u,this.y=e,this.d=l,this.size=h,this.costume=i,this.visible=d}stamp(){this.visible&&s.stamp(this.costume,this.x,this.y,this.d,this.size)}move(u){this.x+=k(this.d)*u,this.y+=w(this.d)*u}}return t},S=(s,t,r)=>({raw_to_stage:(e,l,h=0)=>{const i=s.getBoundingClientRect(),d=((e-i.left)/r.size*100-r.x)*t.stage_width/t.display_width,c=(t.display_height-((l-i.top)/r.size*100-r.y))*t.stage_height/t.display_height,y=h+r.d;return{x:d,y:c,d:y}}}),z=async s=>{const t=document.getElementById(s.canvas_name);t.height=s.stage_height*s.display_quality,t.width=s.stage_width*s.display_quality;const r=t.getContext("2d"),{Images:u,Audios:e,Fonts:l}=await L(),h={up:!1,down:!1,left:!1,right:!1,z:!1,x:!1,c:!1,d:!1},i={x:0,y:0,clicking:!1,is_in_rect(a,n,m,_,p="center"){switch(p){case"center":return a-m/2<this.x&&this.x<a+m/2&&n-_/2<this.y&&this.y<n+_/2;case"start":default:return a<this.x&&this.x<a+m&&n<this.y&&this.y<n+_}}},d={canvas:{size:100,x:0,y:0,d:0}},c=I(t,r,u,l,s,d.canvas),y=E(c);r.imageSmoothingEnabled=!1;const o=S(t,s,d.canvas);return window.addEventListener("keydown",a=>{switch(a.key){case"ArrowUp":h.up=!0;break;case"ArrowDown":h.down=!0;break;case"ArrowLeft":h.left=!0;break;case"ArrowRight":h.right=!0;break;case"z":case"Z":h.z=!0;break;case"x":case"X":h.x=!0;break;case"c":case"C":h.c=!0;break;case"d":case"D":h.d=!0;break}}),window.addEventListener("keyup",a=>{switch(a.key){case"ArrowUp":h.up=!1;break;case"ArrowDown":h.down=!1;break;case"ArrowLeft":h.left=!1;break;case"ArrowRight":h.right=!1;break;case"z":case"Z":h.z=!1;break;case"x":case"X":h.x=!1;break;case"c":case"C":h.c=!1;break;case"d":case"D":h.d=!1;break}}),t.addEventListener("mousedown",a=>{i.clicking=!0;const n=o.raw_to_stage(a.x,a.y);i.x=n.x,i.y=n.y}),t.addEventListener("mousemove",a=>{const n=o.raw_to_stage(a.x,a.y);i.x=n.x,i.y=n.y}),t.addEventListener("mouseup",a=>{i.clicking=!1;const n=o.raw_to_stage(a.x,a.y);i.x=n.x,i.y=n.y}),{canvas:t,ctx:r,Images:u,Audios:e,Fonts:l,inputKeys:h,inputMouse:i,props:d,cLib:c,Sprite:y,for:M,while:A,loop:P}},R=2,T=640,B=480,C=800,D=400,G="canvas",K={display_quality:R,stage_width:T,stage_height:B,display_width:C,display_height:D,canvas_name:G},U=(s,t)=>{let r={};const u=class b extends t{constructor(i,d,c,y,o,a,n,m,_,p){super(i,d,c,y,void 0,!0),this.start_x=i,this.start_y=d,this.start_d=c,this.move_x=a,this.move_y=n,this.move_d=m,this.start_len=o,this.move_len=_,this.len=o,this.age=0,this.id=b.current_id,this.width=y,r[this.id]=this,b.current_id++}move_self(){this.age++,this.x=this.start_x+b.get_move(this.move_x,this.age),this.y=this.start_y+b.get_move(this.move_y,this.age),this.d=this.start_d+b.get_move(this.move_d,this.age),this.len=this.start_len+b.get_move(this.move_len,this.age)}draw(){w(this.d),s.stamp("bone_head_white",this.x+w(this.d)*this.width*8/6,this.y-k(this.d)*this.width*8/6,this.d+180,this.width*100/6,1,"start"),s.drawRect(this.x+k(this.d)*this.width*7/6,this.y+w(this.d)*this.width*7/6,this.width*6/100,this.len,"white",this.d,"start"),s.stamp("bone_head_white",this.x+k(this.d)*(this.len+this.width*14/6)-w(this.d)*this.width*2/6,this.y+w(this.d)*(this.len+this.width*14/6)+k(this.d)*this.width*2/6,this.d,this.width*100/6,1,"start")}static process(){for(const i in r){const d=r[i];d.move_self(),d.draw()}}static get_move(i,d){if(typeof i=="number")return i*d;switch(i.type){case"sin":case"cos":return 0;case"custom":return i.fn(d)}}};u.current_id=0;let e=u;return{boneDict:r,normal:e,process:()=>{e.process()}}},W=async()=>{const s=await z(K),t=new s.Sprite(0,0,0,80,"soul",!0),r=U(s.cLib,s.Sprite);new r.normal(60,180,0,200,200,0,0,2,0,0),s.loop(()=>{s.ctx.clearRect(0,0,s.canvas.width,s.canvas.height),s.inputKeys.up&&(t.y+=3.5),s.inputKeys.down&&(t.y-=3.5),s.inputKeys.right&&(t.x+=3.5),s.inputKeys.left&&(t.x-=3.5),r.process(),t.stamp()})};window.onload=W;
